{% extends "core/authenticated-base.html" %}

{% block title %}Datasets List | EnergyGuard{% endblock %}

{% block content %}
<div class="content">
    <div class="mb-9">

        <!-- HEADER -->
        <div class="row g-3 mb-4 ">
            <div class="col-auto me-4">
                <h2 class="mb-0">Datasets</h2>
            </div>
            <div class="col-auto">
                <a class="btn btn-primary" href="{% url 'dataset_upload' %}"><span class="fas fa-plus me-2"></span>Add new dataset</a>
            </div>
        </div>

        <!-- SUBHEADER -->
        <div class="d-flex justify-content-between">
            <ul class="nav nav-links mb-3 mb-lg-2 mx-n3">
                <li class="nav-item"><a class="nav-link fs-9-5 {%if not status_filter %}active{% endif %}" aria-current="page" href="?"><span>All </span><span class="text-body-tertiary fw-semibold">({{dataset_num.all}})</span></a></li>
                <li class="nav-item"><a class="nav-link fs-9-5 {%if status_filter == 'published' %}active{% endif %}" href="?status=published"><span>Published</span><span class="text-body-tertiary fw-semibold">({{dataset_num.published}})</span></a></li>
                <li class="nav-item"><a class="nav-link fs-9-5 {%if status_filter == 'private' %}active{% endif %}" href="?status=private"><span>Private </span><span class="text-body-tertiary fw-semibold">({{dataset_num.private}})</span></a></li>
                <li class="nav-item"><a class="nav-link fs-9-5 {%if status_filter == 'restricted' %}active{% endif %}" href="?status=restricted"><span>Restricted </span><span class="text-body-tertiary fw-semibold">({{dataset_num.restricted}})</span></a></li>
                <li class="nav-item"><a class="nav-link fs-9-5 {%if status_filter == 'under_review' %}active{% endif %}" href="?status=under_review"><span>Under Review </span><span class="text-body-tertiary fw-semibold">({{dataset_num.under_review}})</span></a></li>
            </ul>
            <!-- SEARCH BAR -->
            <div class="mb-4">
                <div class="row g-3">
                    <div class="col-auto">
                        <div class="search-box">
                            <form class="position-relative" id="datasetSearchForm" onsubmit="return false;">
                                <input id="datasetSearchInput" class="form-control search-input search fs-9-5" type="search" placeholder="Search datasets" aria-label="Search" />
                                <span class="fas fa-search search-box-icon fs-9-5"></span>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <div class="mx-n4 px-4 mx-lg-n6 px-lg-6 bg-body-emphasis border-top border-bottom border-translucent position-relative top-1">
                <div class="table-responsive scrollbar mx-n1 px-1">
                    <table class="table table-sm fs-9 mb-0" id="datasetsList" style="width: 100%;">
                        <thead>
                            <tr>
                                <th class="sort white-space-nowrap align-middle pe-3 fs-10" scope="col" style="width:17%;">DATASET NAME</th>
                                <!-- <th class="sort align-middle text-start" scope="col" style="width:10%;">COLLABORATORS</th> -->
                                <th class="sort align-middle text-end fs-10" scope="col" style="width:6%;">CREATED</th>
                                <!-- <th class="sort align-middle text-end" scope="col" style="width:8%;">UPDATED</th> -->
                                <th class="sort align-middle text-end fs-10" scope="col" style="width:12%;">LABEL</a></th>
                                <th class="sort align-middle text-end fs-10" scope="col" style="width:10%;">SOURCE</th>
                                <th class="sort align-middle text-end fs-10" scope="col" style="width:15%;">PUBLISHER</th>
                                <th class="sort align-middle text-end fs-10" scope="col" style="width:5%;">SIZE</th>
                                <th class="sort align-middle text-end fs-10" scope="col" style="width:5%;">DOWNLOADS</th>
                                <th class="sort align-middle text-end fs-10" scope="col" style="width:6%;">STATUS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- {% for d in dataset %}
                            <tr class="hover-actions-trigger btn-reveal-trigger position-static">
                                <td class="fs-9 align-middle px-0 py-3">
                                    <div class="form-check mb-0 fs-8">
                                        <input class="form-check-input" type="checkbox"/>
                                    </div>
                                </td>
                                <td class="align-middle white-space-nowrap py-0"><a class="fw-semibold" target="_blank" href="">{{ name }}</a></td>
                                <td class="align-middle fw-semibold text-body-highlight">
                                    {% for user in d.users.all %}
                                        {{ user.username }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                    {% if d.users.count == 0 %}
                                        No collaborators
                                    {% endif %}
                                </td>
                                <td class="align-middle white-space-nowrap text-body-tertiary fs-9 ps-4 text-end">{{ created_at|date:"M j, Y" }}</td>
                                <td class="align-middle white-space-nowrap text-body-tertiary fs-9 ps-4 text-end">{{ updated_at|date:"M j, Y" }}</td>
                                <td class="align-middle white-space-nowrap text-body-tertiary fs-9 ps-4 text-end">{{ get_label_display }}</td>
                                <td class="align-middle white-space-nowrap text-body fs-9 ps-4 text-end">{{ get_source_display }}</td>
                                <td class="align-middle white-space-nowrap text-end fw-bold text-body-tertiary">
                                    {% if d.status == 'published' %}
                                        <span class="badge badge-phoenix fs-10 badge-phoenix-secondary"><span class="badge-label">PUBLISHED</span><span class="ms-1" data-feather="clock" style="height:12.8px;width:12.8px;"></span></span>
                                    {% elif d.status == 'private' %}
                                        <span class="badge badge-phoenix fs-10 badge-phoenix-secondary"><span class="badge-label">PRIVATE</span><span class="ms-1" data-feather="x" style="height:12.8px;width:12.8px;"></span></span>
                                    {% elif d.status == 'restricted' %}
                                        <span class="badge badge-phoenix fs-10 badge-phoenix-secondary"><span class="badge-label">RESTRICTED</span><span class="ms-1" data-feather="lock" style="height:12.8px;width:12.8px;"></span></span>
                                    {% elif d.status == 'under_review' %}
                                        <span class="badge badge-phoenix fs-10 badge-phoenix-secondary"><span class="badge-label">UNDER REVIEW</span><span class="ms-1" data-feather="eye" style="height:12.8px;width:12.8px;"></span></span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %} -->
                        </tbody>   
                    </table>
                </div>
            </div>
        </div>
        {% include "core/footer.html" %}
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
    $(document).ready(function () {
        const statusParam = new URLSearchParams(window.location.search).get('status') || '';

        const table = $('#datasetsList').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "{% url 'datasets_list_json' %}",
                data: function (d) {
                    d.status = statusParam;
                },
                type: "GET"
            },
            columns: [
                { 
                    data: "name", 
                    render: function(data, type, row) {
                        return `<a class="fw-semibold fs-9-5" href="/datasets/dataset/${row.id}/">${data}</a>`;
                    }
                },
                // { data: "users", "orderable": false },
                { data: "created_at", className: "text-end fs-9-5" },
                { data: "label", className: "text-end fs-9-5" },
                { data: "source", className: "text-end fs-9-5" },
                { data: "publisher", className: "text-end fs-9-5" },
                { data: "size_gb", render: function(data) {
                        return data + ' GB';
                    }, className: "text-end fs-9-5" 
                },
                { data: "downloads", className: "text-end fs-9-5" },
                { data: "status", className: "text-end", "orderable": false },
                { data: "id", visible: false }
            ],
            order: [[1, "desc"]], // Default sort by 'name' descending
            dom: 'rt<"row"<"col-sm-12 col-md-7 fs-9-5 mt-4"i><"col-sm-12 col-md-5 mt-4 d-flex justify-content-end"p>>', // Custom DOM layout
            pageLength: 15,
            createdRow: row => $('td', row).addClass('align-middle py-3'),
        });

        $('#datasetSearchInput').on('keyup change', function () {
            table.search(this.value).draw();
        });
    });
</script>
{% endblock scripts %}
