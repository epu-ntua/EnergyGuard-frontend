{% extends "core/authenticated-base.html" %}

{% block title %}Datasets List | EnergyGuard{% endblock %}

{% block content %}
<div class="content">
    <div class="mb-9">

        <!-- HEADER -->
        <div class="row g-3 mb-6">
            <div class="col-auto me-4">
                <h2 class="mb-0">Datasets</h2>
            </div>
            <div class="col-auto">
                <a class="btn btn-primary" href="{% url 'dataset_upload' %}"><span class="fas fa-plus me-2"></span>Add new dataset</a>
            </div>
        </div>

        <ul class="nav nav-underline" id="datasetsTab" role="tablist">
            <li class="nav-item me-3"><a class="nav-link fs-8 {% if active_tab == 'public' %}active{% endif %}" id="publicDatasets-tab" data-bs-toggle="tab" href="#tab-publicDatasets" role="tab" aria-controls="tab-publicDatasets" aria-selected="{% if active_tab == 'public' %}true{% else %}false{% endif %}">Public datasets</a></li>
            <li class="nav-item"><a class="nav-link fs-8 {% if active_tab == 'my' %}active{% endif %}" id="myDatasets-tab" data-bs-toggle="tab" href="#tab-myDatasets" role="tab" aria-controls="tab-myDatasets" aria-selected="{% if active_tab == 'my' %}true{% else %}false{% endif %}">My datasets</a></li>
        </ul>

        <div class="tab-content mt-5" id="datasetsTabContent">
            <!-- Public datasets tab -->
            <div class="tab-pane fade {% if active_tab == 'public' %}show active{% endif %}" id="tab-publicDatasets" role="tabpanel" aria-labelledby="publicDatasets-tab">
                <div class="d-flex justify-content-between">
                    <ul class="nav nav-links mb-3 mb-lg-2 mx-n3">
                        <li class="nav-item"><a class="nav-link fs-9 {%if not label_filter %}active{% endif %}" aria-current="page" href="?tab=public"><span>All </span><span class="text-body-tertiary fw-semibold">({{public_datasets_num.all}})</span></a></li>
                        {% for tab in label_tabs %}
                        <li class="nav-item"><a class="nav-link fs-9{%if label_filter == tab.value %}active{% endif %}" href="?tab=public&label={{ tab.value }}"><span>{{ tab.display }}</span><span class="text-body-tertiary fw-semibold">({{ tab.public_count }})</span></a></li>
                        {% endfor %}
                    </ul>
                    <div class="mb-4">
                        <div class="row g-3">
                            <div class="col-auto">
                                <div class="search-box">
                                    <form class="position-relative" onsubmit="return false;">
                                        <input id="publicDatasetSearchInput" class="form-control search-input search fs-9" type="search" placeholder="Search datasets" aria-label="Search" />
                                        <span class="fas fa-search search-box-icon fs-9"></span>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="mx-n4 px-4 mx-lg-n6 px-lg-6 bg-body-emphasis border-top border-bottom border-translucent position-relative top-1">
                        <div class="table-responsive scrollbar mx-n1 px-1">
                            <table class="table table-sm fs-9 mb-0" id="publicDatasetsList" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th class="sort white-space-nowrap align-middle pe-3 fs-9" scope="col" style="width:17%;">DATASET NAME</th>
                                        <th class="sort align-middle text-end fs-9" scope="col" style="width:6%;">CREATED</th>
                                        <th class="sort align-middle text-end fs-9" scope="col" style="width:12%;">LABEL</th>
                                        <th class="sort align-middle text-end fs-9" scope="col" style="width:10%;">SOURCE</th>
                                        <th class="sort align-middle text-end fs-9" scope="col" style="width:15%;">PUBLISHER</th>
                                        <th class="sort align-middle text-end fs-9" scope="col" style="width:5%;">SIZE</th>
                                        <th class="sort align-middle text-end fs-9" scope="col" style="width:6%;">DOWNLOADS</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My datasets tab -->
            <div class="tab-pane fade {% if active_tab == 'my' %}show active{% endif %}" id="tab-myDatasets" role="tabpanel" aria-labelledby="myDatasets-tab">
                <div class="d-flex justify-content-between">
                    <ul class="nav nav-links mb-3 mb-lg-2 mx-n3">
                        <li class="nav-item"><a class="nav-link fs-9 {%if not label_filter %}active{% endif %}" aria-current="page" href="?tab=my"><span>All </span><span class="text-body-tertiary fw-semibold">({{my_datasets_num.all}})</span></a></li>
                        {% for tab in label_tabs %}
                        <li class="nav-item"><a class="nav-link fs-9 {%if label_filter == tab.value %}active{% endif %}" href="?tab=my&label={{ tab.value }}"><span>{{ tab.display }}</span><span class="text-body-tertiary fw-semibold">({{ tab.my_count }})</span></a></li>
                        {% endfor %}
                    </ul>
                    <div class="mb-4">
                        <div class="row g-3">
                            <div class="col-auto">
                                <div class="search-box">
                                    <form class="position-relative" onsubmit="return false;">
                                        <input id="myDatasetSearchInput" class="form-control search-input search fs-9" type="search" placeholder="Search datasets" aria-label="Search" />
                                        <span class="fas fa-search search-box-icon fs-9"></span>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="mx-n4 px-4 mx-lg-n6 px-lg-6 bg-body-emphasis border-top border-bottom border-translucent position-relative top-1">
                        <div class="table-responsive scrollbar mx-n1 px-1">
                            <table class="table table-sm fs-9 mb-0" id="myDatasetsList" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th class="sort white-space-nowrap align-middle pe-3 fs-9" scope="col" style="width:17%;">DATASET NAME</th>
                                        <th class="sort align-middle text-end fs-9" scope="col" style="width:6%;">CREATED</th>
                                        <th class="sort align-middle text-end fs-9" scope="col" style="width:12%;">LABEL</th>
                                        <th class="sort align-middle text-end fs-9" scope="col" style="width:10%;">SOURCE</th>
                                        <th class="sort align-middle text-end fs-9" scope="col" style="width:15%;">PUBLISHER</th>
                                        <th class="sort align-middle text-end fs-9" scope="col" style="width:5%;">SIZE</th>
                                        <th class="sort align-middle text-end fs-9" scope="col" style="width:6%;">STATUS</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% include "core/footer.html" %}
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
    $(document).ready(function () {
        const labelParam = new URLSearchParams(window.location.search).get('label') || '';
        const columns = [
            {
                data: "name",
                render: function(data, type, row) {
                    return `<a class="fw-semibold fs-9" href="/datasets/dataset/${row.id}/">${data}</a>`;
                }
            },
            { data: "created_at", className: "text-end fs-9" },
            { data: "label", className: "text-end fs-9" },
            { data: "source", className: "text-end fs-9" },
            { data: "publisher", className: "text-end fs-9" },
            {
                data: "size_gb",
                render: function(data) {
                    return data + " GB";
                },
                className: "text-end fs-9"
            },
            { data: "status", className: "text-end fs-9", orderable: false },
            { data: "id", visible: false }
        ];

        const publicTable = $("#publicDatasetsList").DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "{% url 'datasets_list_json' %}",
                data: function(d) {
                    d.label = labelParam;
                    d.scope = "public";
                },
                type: "GET"
            },
            columns: columns,
            order: [[1, "desc"]],
            dom: 'rt<"row"<"col-sm-12 col-md-7 fs-9 mt-4"i><"col-sm-12 col-md-5 mt-4 d-flex justify-content-end"p>>',
            pageLength: 15,
            createdRow: row => $("td", row).addClass("align-middle py-3"),
        });

        const myTable = $("#myDatasetsList").DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "{% url 'datasets_list_json' %}",
                data: function(d) {
                    d.label = labelParam;
                    d.scope = "my";
                },
                type: "GET"
            },
            columns: columns,
            order: [[1, "desc"]],
            dom: 'rt<"row"<"col-sm-12 col-md-7 fs-9 mt-4"i><"col-sm-12 col-md-5 mt-4 d-flex justify-content-end"p>>',
            pageLength: 15,
            createdRow: row => $("td", row).addClass("align-middle py-3"),
        });

        $("#publicDatasetSearchInput").on("keyup change", function() {
            publicTable.search(this.value).draw();
        });

        $("#myDatasetSearchInput").on("keyup change", function() {
            myTable.search(this.value).draw();
        });
    });
</script>
{% endblock scripts %}
