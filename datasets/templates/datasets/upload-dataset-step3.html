{% extends "core/base-wizard.html" %}
{% load static %}

{% block title %}Add Dataset | EnergyGuard{% endblock %}
{% block wizard_title %} Create a new dataset{% endblock wizard_title %}

{% block content %}
<div class="tab-content">
    <div class="tab-pane active" role="tabpanel">
        <form class="needs-validation" action="" method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            {{ wizard.management_form }}
            <input type="hidden" name="wizard_goto_step" id="wizard_goto_step" value="">
            {{ wizard.form.metadata_rows }}

            {% if wizard.form.non_field_errors %}
            <div class="mb-3 p-2 alert alert-danger" role="alert">
                {{ wizard.form.non_field_errors }}
            </div>
            {% endif %}

            <div class="mb-5">
                <label class="form-label text-body">Upload Metadata File</label>
                {{ wizard.form.metadata_file }}
                {% if wizard.form.errors.metadata_file %}
                <div class="mt-1 p-0 alert text-danger-emphasis small" role="alert">{{ wizard.form.errors.metadata_file }}</div>
                {% endif %}
            </div>

            <div class="mb-3">
                <p class="text-center fs-9 text-body-quaternary">or Insert metadata information manually</p>
            </div>

            {{ wizard.form.metadata }}

            <div class="mb-3">
                <p class="col-12 fs-9">Dataset Type</p>
                <div id="boxes" class="mb-3">
                    <div class="row gx-2 mb-2">
                        <div class="col-4">
                            <div class="fs-9 text-body-quaternary border rounded-2 py-2 ps-2">
                                <p class="mb-0 fw-bold">FEATURE NAME</p>
                                <p class="mb-0">Name of column</p>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="fs-9 text-body-quaternary border rounded-2 py-2 ps-2">
                                <p class="mb-0 fw-bold">UNIT</p>
                                <p class="mb-0">Measurement unit</p>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="fs-9 text-body-quaternary border rounded-2 py-2 ps-2">
                                <p class="mb-0 fw-bold">DESCRIPTION</p>
                                <p class="mb-0">Description of column</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button type="button" class="btn btn-primary py-1 px-4" onclick="addRow()"><span class="fw-bolder fs-8">+ </span>Add row</button>
                </div>

            </div>

            <div class="d-flex justify-content-between gap-2 mt-5 mb-3">
                <button type="button" class="btn btn-link" onclick="document.getElementById('wizard_goto_step').value='{{ wizard.steps.prev }}'; this.form.submit();"><span class="fas fa-chevron-left me-1" data-fa-transform="shrink-3"></span>Back</button>
                <button type="submit" class="btn btn-primary px-6 px-sm-6">Next</button>
            </div>
        </form>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
  function addRow() {
    var container = document.getElementById('boxes');
    var row = document.createElement('div');
    row.setAttribute('data-row-wrapper', 'true');
    row.innerHTML = `
    <div class="text-end mb-0">
        <button type="button" class="btn btn-danger px-2 py-0" onclick="removeRow(this)"><span class="fw-bolder fs-8">-</span></button>
    </div>
    <div class="row gx-2 mb-1" data-metadata-row="true">
        <div class="col-4">
            <div class="fs-9 text-body-quaternary">
                <input type="text" data-field="feature_name" class="form-control form-control-sm">
            </div>
        </div>
        <div class="col-4">
            <div class="fs-9 text-body-quaternary">
                <input type="text" data-field="feature_unit" class="form-control form-control-sm">
            </div>
        </div>
        <div class="col-4">
            <div class="fs-9 text-body-quaternary">
                <input type="text" data-field="feature_description" class="form-control form-control-sm">
            </div>
        </div>
    </div>
    `;
    container.appendChild(row);
  }

  function removeRow(button) {
    var rowWrapper = button.closest('[data-row-wrapper="true"]');
    if (rowWrapper) {
      rowWrapper.remove();
    }
  }

  (function bindMetadataRowsSerializer() {
    var metadataRowsInput = document.querySelector('input[name$="metadata_rows"]');
    if (!metadataRowsInput) {
      return;
    }
    var form = metadataRowsInput.closest('form');
    if (!form) {
      return;
    }

    form.addEventListener('submit', function () {
      var rows = [];
      var rowElements = form.querySelectorAll('[data-metadata-row="true"]');

      rowElements.forEach(function (rowElement) {
        var featureNameInput = rowElement.querySelector('[data-field="feature_name"]');
        var featureUnitInput = rowElement.querySelector('[data-field="feature_unit"]');
        var featureDescriptionInput = rowElement.querySelector('[data-field="feature_description"]');

        var featureName = featureNameInput ? featureNameInput.value.trim() : '';
        var featureUnit = featureUnitInput ? featureUnitInput.value.trim() : '';
        var featureDescription = featureDescriptionInput ? featureDescriptionInput.value.trim() : '';

        if (featureName || featureUnit || featureDescription) {
          rows.push({
            feature_name: featureName,
            feature_unit: featureUnit,
            feature_description: featureDescription
          });
        }
      });

      metadataRowsInput.value = JSON.stringify(rows);
    });
  })();
</script>
{% endblock scripts %}
