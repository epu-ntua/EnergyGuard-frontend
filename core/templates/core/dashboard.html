{% extends "core/authenticated-base.html" %}
{% load static %}

{% block title %}Dashboard | EnergyGuard{% endblock title %}

{% block content %}
<div class="content px-9 mt-5">

  <!-- TITLE -->
  <div class="row gy-3 mb-6 justify-content-between">
    <div class="col-md-9 col-auto">
      <h2 class="mb-2 text-body-emphasis">Dashboard</h2>
      <h5 class="text-body-tertiary fw-semibold">A snapshot of whatâ€™s available across the EnergyGuard platform</h5>
    </div>
  </div>

  <div class="row mb-9 gy-6">
    <div class="col-12">
      <div class="d-inline-flex flex-column flex-md-row align-items-md-center gap-3 border border-2 border-dashed rounded-3 p-5">
        <!-- WELCOME CARD -->
        <div class="me-3">
          <h3 class="mb-3">Welcome to EnergyGuard</h3>
          <h4 class="fw-normal mb-0">Create your first Team to start managing projects, datasets and AI models</h4>
        </div>
        <div>
          <a href=""><button class="btn btn-primary btn-lg">Create Team</button></a>
        </div>
      </div>
    </div>
  </div>

  <!-- 1ST LEVEL CARDS -->
  <div class="row mb-5 gy-6">
    <div class="col-12 col-xxl-2">
      <div class="row align-items-center g-3 g-xxl-0 h-100 align-content-between">
        
        <!-- PROJECTS -->
        <div class="col-12 col-sm-6 col-md-3 col-lg-6 col-xl-3 col-xxl-12">
          <a href="{% url 'experiments_list' %}" class=" text-decoration-none">
            <div class="d-flex align-items-center"><span class="fs-4 lh-1 uil  uil-notebooks text-primary-dark"></span>
              <div class="ms-2">
                <div class="d-flex align-items-end">
                  <h2 class="mb-0 me-2">{{ projects_count }}</h2><span class="fs-7 fw-semibold text-body">Projects</span>
                </div>
                <p class="text-body-secondary fs-9 mb-0">Created in the platform</p>
              </div>
            </div>
          </a>
        </div>
        <!-- DATASETS -->
        <div class="col-12 col-sm-6 col-md-3 col-lg-6 col-xl-3 col-xxl-12">
          <a href="{% url 'datasets_list' %}" class=" text-decoration-none">
            <div class="d-flex align-items-center"><span class="fs-4 lh-1 uil uil-database text-warning-dark"></span>
              <div class="ms-2">
                <div class="d-flex align-items-end">
                  <h2 class="mb-0 me-2">{{ datasets_count }}</h2><span class="fs-7 fw-semibold text-body">Datasets</span>
                </div>
                <p class="text-body-secondary fs-9 mb-0">Ready to explore</p>
              </div>
            </div>
          </a>
        </div>
        <!-- AI MODELS -->
        <div class="col-12 col-sm-6 col-md-3 col-lg-6 col-xl-3 col-xxl-12">
          <a href="" class=" text-decoration-none">
            <div class="d-flex align-items-center"><span class="fs-4 lh-1 uil uil-cube text-danger-dark"></span>
              <div class="ms-2">
                <div class="d-flex align-items-end">
                  <!-- TODO: Replace with dynamic count -->
                  <h2 class="mb-0 me-2">37</h2><span class="fs-7 fw-semibold text-body">AI Models</span>
                </div>
                <p class="text-body-secondary fs-9 mb-0">Registered & deployable</p>
              </div>
            </div>
          </a>
        </div>
        <!-- DTs -->
        <div class="col-12 col-sm-6 col-md-3 col-lg-6 col-xl-3 col-xxl-12">
          <a href="" class=" text-decoration-none">
            <div class="d-flex align-items-center"><span class="fs-4 lh-1 uil uil-building text-success-dark"></span>
              <div class="ms-2">
                <div class="d-flex align-items-end">
                  <!-- TODO: Replace with dynamic count -->
                  <h2 class="mb-0 me-2">24</h2><span class="fs-7 fw-semibold text-body">Digital Twins</span>
                </div>
                <p class="text-body-secondary fs-9 mb-0">Configured & accessible</p>
                <p class="text-body-secondary fs-9 mb-0">Connected to datasets/models</p>
              </div>
            </div>
          </a>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-6 col-xxl-5">
      <h3 class="text-body-emphasis mb-1">Datasets Coverage by Domain</h3>
      <div class="fs-8">Distribution of datasets currently available on the platform</div>
      <div id="sortedBarChart" style="height: 420px;"></div>
      <div class="border-0 "><a class="fw-bold fs-9 mt-3" href="{% url 'datasets_list' %}">Explore Datasets<span class="fas fa-angle-right ms-2 fs-10 text-center"></span></a></div>
    </div>
    {{ chart_data|json_script:"sorted-bar-data" }}
    
    <!-- CARD -->
    <div class="col-12 col-xl-6 col-xxl-5">
      <div class="card border h-100 w-100 overflow-hidden">
        {% static 'assets/img/spot-illustrations/32.png' as ill_32 %}
        <div class="bg-holder d-block bg-card" style="background-image:url('{{ ill_32 }}');background-position: top right;">
        </div>
        <!--/.bg-holder-->

        <div class="d-dark-none">
          {% static 'assets/img/spot-illustrations/dark_32.png' as dark_ill_32 %}
          <div class="bg-holder d-none d-sm-block d-xl-none d-xxl-block bg-card" style="background-image:url('{{ dark_ill_32 }}');background-position: bottom right; background-size: auto;">
          </div>
          <!--/.bg-holder-->
        </div>
        <div class="d-light-none">
          {% static 'assets/img/spot-illustrations/21.png' as ill_21 %}
          <div class="bg-holder d-none d-sm-block d-xl-none d-xxl-block bg-card" style="background-image:url('{{ ill_21 }}');background-position: bottom right; background-size: auto;">
          </div>
          <!--/.bg-holder-->
        </div>
        <div class="card-body px-5 position-relative">
          <div class="badge badge-phoenix fs-10 badge-phoenix-warning mb-4"><span class="fw-bold">Trustworthiness</span><span class="fa-solid fa-award ms-1"></span></div>
          <h3 class="mb-5">Trustworthiness assessments</h3>
          <p class="text-body-tertiary fw-semibold">Assess AI Models and Digital Twins <br class="d-none d-sm-block" />across key trust dimensions (e.g., robustness, <br class="d-none d-sm-block" />explainability, safety checks).</p>
          <ul class="mb-4">
            <li class="ls-2 mb-2"><span class="fw-bold">8 </span> Different Benchmarks</li>
            <li class="ls-2 mb-2"><span class="fw-bold">56 </span> Assessments conducted</li>
            <li class="ls-2">Man in the loop</li>
          </ul>
          <div class="py-0  z-1 ">
            <button class="btn btn-outline-primary p-2">Learn how trustworthiness works<i class="fa-solid fa-angle-right ms-2"></i></button>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- 2ND LEVEL CARDS -->
  <div class="mx-n4 px-4 mx-lg-n6 px-lg-6 bg-body-emphasis pt-7 pb-3 border-y mb-5">
    <div class="row gx-5">
      <!-- DONUT -->
      <div class="col-12 col-xl-5 pe-lg-6">
        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6">
              <h3 class="text-body-emphasis text-nowrap">AI Models Inventory</h3>
              <p class="text-body-tertiary mb-md-7">How registered models are distributed by model type</p>
              <!-- LEGEND -->
              <div id="donutLegend" style="width: 100%; min-height: 220px;"></div>
              <div class="border-0"><a class="fw-bold fs-9 mt-3" href="#!">Browse AI Models<span class="fas fa-angle-right ms-2 fs-10 text-center"></span></a></div>
          </div>
          <div class="col-12 col-md-6">
            <div class="position-relative mb-sm-4 mb-xl-0">
              <div id="aiModelsDonutChart" style="width: 100%; height: 350px;"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- HPC -->
      <div class="col-12 col-xl-7 ps-lg-6">
        <h3>HPC Availability</h3>
        <p class="text-body-tertiary mb-0 mb-xl-3">Compute resources available for training, simulation and evaluation workloads</p>
        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Laborum eius, est soluta facilis doloremque possimus asperiores dolores sapiente necessitatibus in quaerat tempora totam nisi nulla, magni cumque laboriosam harum reiciendis?</p>
      </div>  
    </div>
  </div>

  {% include 'core/footer.html' %}
</div>

{% endblock content %}

{% block scripts %}

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>


<!-- Change text color in charts for dark mode -->
<script>
function cssColorToAmColor(cssColor) {
  if (!cssColor) {
    return am5.color(0x31374a);
  }

  var color = cssColor.trim();
  if (color.charAt(0) === "#") {
    return am5.color(parseInt(color.slice(1), 16));
  }

  var rgb = color.match(/\d+/g);
  if (rgb && rgb.length >= 3) {
    return am5.color((parseInt(rgb[0], 10) << 16) + (parseInt(rgb[1], 10) << 8) + parseInt(rgb[2], 10));
  }

  return am5.color(0x31374a);
}

function getThemeTextColor() {
  var styles = getComputedStyle(document.documentElement);
  return styles.getPropertyValue("--phoenix-emphasis-color") || styles.getPropertyValue("--phoenix-body-color");
}
</script>

<!-- Bar Chart - Datasets -->
<script>
am5.ready(function() {
  var data = JSON.parse(document.getElementById("sorted-bar-data").textContent || "[]").map(function(item) {
    return {
      category: item.category,
      value: Number(item.value) || 0
    };
  });

  var root = am5.Root.new("sortedBarChart");
  root.setThemes([am5themes_Animated.new(root)]);

  var chart = root.container.children.push(am5xy.XYChart.new(root, {
    panX: false,
    panY: false,
    wheelX: "none",
    wheelY: "none",
    paddingLeft: 0
  }));
  chart.zoomOutButton.set("forceHidden", true);

  var yRenderer = am5xy.AxisRendererY.new(root, {
    minGridDistance: 30,
    minorGridEnabled: true
  });
  yRenderer.grid.template.set("location", 1);

  var yAxis = chart.yAxes.push(am5xy.CategoryAxis.new(root, {
    maxDeviation: 0,
    categoryField: "category",
    renderer: yRenderer,
    tooltip: am5.Tooltip.new(root, { themeTags: ["axis"] })
  }));

  var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root, {
    maxDeviation: 0,
    min: 0,
    numberFormatter: am5.NumberFormatter.new(root, {
      numberFormat: "#,###"
    }),
    extraMax: 0.1,
    renderer: am5xy.AxisRendererX.new(root, {
      strokeOpacity: 0.1,
      minGridDistance: 80
    })
  }));

  var series = chart.series.push(am5xy.ColumnSeries.new(root, {
    name: "Datasets",
    xAxis: xAxis,
    yAxis: yAxis,
    valueXField: "value",
    categoryYField: "category",
    tooltip: am5.Tooltip.new(root, {
      pointerOrientation: "left",
      labelText: "{categoryY}: {valueX}"
    })
  }));

  series.columns.template.setAll({
    cornerRadiusTR: 5,
    cornerRadiusBR: 5,
    strokeOpacity: 0
  });

  series.columns.template.adapters.add("fill", function(fill, target) {
    return chart.get("colors").getIndex(series.columns.indexOf(target));
  });

  series.columns.template.adapters.add("stroke", function(stroke, target) {
    return chart.get("colors").getIndex(series.columns.indexOf(target));
  });

  yAxis.data.setAll(data);
  series.data.setAll(data);

  function getSeriesItem(category) {
    for (var i = 0; i < series.dataItems.length; i++) {
      var dataItem = series.dataItems[i];
      if (dataItem.get("categoryY") === category) {
        return dataItem;
      }
    }
    return null;
  }

  function sortCategoryAxis() {
    series.dataItems.sort(function(x, y) {
      return x.get("valueX") - y.get("valueX");
    });

    am5.array.each(yAxis.dataItems, function(dataItem) {
      var seriesDataItem = getSeriesItem(dataItem.get("category"));
      if (seriesDataItem) {
        var index = series.dataItems.indexOf(seriesDataItem);
        var deltaPosition = (index - dataItem.get("index", 0)) / series.dataItems.length;
        dataItem.set("index", index);
        dataItem.set("deltaPosition", -deltaPosition);
        dataItem.animate({
          key: "deltaPosition",
          to: 0,
          duration: 700,
          easing: am5.ease.out(am5.ease.cubic)
        });
      }
    });

    yAxis.dataItems.sort(function(x, y) {
      return x.get("index") - y.get("index");
    });
  }

  function applyBarChartTextColors() {
    var textColor = cssColorToAmColor(getThemeTextColor());
    yRenderer.labels.template.setAll({ fill: textColor });
    xAxis.get("renderer").labels.template.setAll({ fill: textColor });
  }

  sortCategoryAxis();
  applyBarChartTextColors();

  var barThemeObserver = new MutationObserver(function() {
    applyBarChartTextColors();
  });
  barThemeObserver.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["data-bs-theme"]
  });

  root.events.on("dispose", function() {
    barThemeObserver.disconnect();
  });

  chart.set("cursor", am5xy.XYCursor.new(root, {
    behavior: "none",
    xAxis: xAxis,
    yAxis: yAxis
  }));

  series.appear(1000);
  chart.appear(1000, 100);
});
</script>

<!-- Donut Chart - AI Models -->
<script>
am5.ready(function() {
  var donutElement = document.getElementById("aiModelsDonutChart");
  var donutLegendElement = document.getElementById("donutLegend");
  if (!donutElement || !donutLegendElement) {
    return;
  }

  var donutData = [
    { category: "ML", value: 49 },
    { category: "Deep Learning", value: 18 },
    { category: "Time-series / Forecasting", value: 33 }
  ];

  var donutRoot = am5.Root.new("aiModelsDonutChart");
  donutRoot.setThemes([am5themes_Animated.new(donutRoot)]);

  var donutChart = donutRoot.container.children.push(am5percent.PieChart.new(donutRoot, {
    innerRadius: am5.percent(60),
    centerY: am5.percent(50),
    y: am5.percent(46)
  }));

  var donutSeries = donutChart.series.push(am5percent.PieSeries.new(donutRoot, {
    valueField: "value",
    categoryField: "category",
    alignLabels: false
  }));

  donutSeries.labels.template.set("forceHidden", true);
  donutSeries.ticks.template.set("forceHidden", true);
  donutSeries.data.setAll(donutData);

  var legendRoot = am5.Root.new("donutLegend");
  legendRoot.setThemes([am5themes_Animated.new(legendRoot)]);

  var donutLegend = legendRoot.container.children.push(am5.Legend.new(legendRoot, {
    width: am5.p100,
    height: am5.p100,
    nameField: "name",
    fillField: "fill",
    strokeField: "stroke",
    layout: legendRoot.verticalLayout
  }));

  donutLegend.itemContainers.template.setAll({
    paddingTop: 6,
    paddingBottom: 6
  });
  donutLegend.valueLabels.template.set("forceHidden", true);

  function applyDonutLegendTextColors() {
    var textColor = cssColorToAmColor(getThemeTextColor());
    donutLegend.labels.template.setAll({ fill: textColor });
    donutLegend.valueLabels.template.setAll({ fill: textColor });
  }

  applyDonutLegendTextColors();

  var donutThemeObserver = new MutationObserver(function() {
    applyDonutLegendTextColors();
  });
  donutThemeObserver.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["data-bs-theme"]
  });

  donutRoot.events.on("dispose", function() {
    donutThemeObserver.disconnect();
  });

  donutLegend.data.setAll(donutData.map(function(d, i) {
    var c = donutSeries.get("colors").getIndex(i);
    return { name: d.category + " " + d.value + "%", fill: c, stroke: c };
  }));

  donutSeries.appear(1000, 100);
});
</script>

{% endblock scripts %}



